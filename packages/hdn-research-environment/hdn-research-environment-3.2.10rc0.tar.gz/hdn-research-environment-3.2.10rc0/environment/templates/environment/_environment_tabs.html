<div class="card" id="environment-tabs">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item">
        <a
          class="nav-link active"
          id="environments-tab"
          data-toggle="tab"
          href="#environments"
          role="tab"
          aria-controls="environments"
          aria-selected="true"
        >
          Running Environments
        </a>
      </li>
       <li class="nav-item">
        <a
          class="nav-link"
          id="bucket-sharing-tab"
          data-toggle="tab"
          href="#bucket_sharing"
          role="tab"
          aria-controls="bucket_sharing"
          aria-selected="false"
        >
          Sharing
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link"
          id="billing-accounts-tab"
          data-toggle="tab"
          href="#billing_accounts"
          role="tab"
          aria-controls="billing_accounts"
          aria-selected="false"
        >
          Billing
        </a>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">
      <div
        class="tab-pane fade show active"
        id="environments"
        role="tabpanel"
        aria-labelledby="environments-tab"
      >
        {% include "environment/_available_environments_list.html" %}
      </div>
       <div
        class="tab-pane fade"
        id="bucket_sharing"
        role="tabpanel"
        aria-labelledby="bucket-sharing-tab"
      >
        {% include "environment/_shared_buckets_list.html" %}
      </div>
      <div
        class="tab-pane fade"
        id="billing_accounts"
        role="tabpanel"
        aria-labelledby="billing-accounts-tab"
      >
        {% include "environment/_billing_accounts_list.html" %}
      </div>
    </div>
  </div>
</div>

<script>
    $(document).on('show.bs.modal', '.modal', function () {
      isModalOpen = true;
    });

    $(document).on('hidden.bs.modal', '.modal', function () {
      if (cardToRefresh !== "") {
        pollExecutionStatus(cardToRefresh);
      }

      cardToRefresh = "";
      isModalOpen = false;
    });


    function refreshCards(executionId) {
        fetchNewCards(executionId)
        .then(html => {
          if (html) {
              $("#environment-tabs").html(html);
            };
         });
    }

    function pollExecutionStatus(executionId) {
        const pollUrl = `{% url "check_execution_status" %}?execution_resource_name=${executionId}`;
        fetch(pollUrl)
        .then(response => response.json())
        .then(({ finished }) => {
            if (finished) {
                refreshCards(executionId);
            }
        });
    }

    {% for workflow in workflows %}
        pollExecutionStatus("{{ workflow.execution_resource_name }}");
    {% endfor %}
</script>
