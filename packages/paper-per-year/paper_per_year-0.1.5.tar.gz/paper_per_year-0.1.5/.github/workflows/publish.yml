# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Publish to PyPI and Generate SLSA Provenance

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      digests: ${{ steps.hash.outputs.digests }}
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build
    - name: Build package
      run: python -m build
    
    # Generate provenance subject
    - name: Generate subject for provenance
      id: hash
      run: |
        set -euo pipefail
        # List all dist files
        files=$(ls dist/*)
        # Generate the subjects (base64 encoded)
        echo "hashes=$(sha256sum $files | base64 -w0)" >> "${GITHUB_OUTPUT}"

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1

  provenance:
    needs: [build]
    permissions:
      actions: read   # To read the workflow path
      id-token: write # To sign the provenance
      contents: write # To add assets to a release
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.4.0
    with:
      base64-subjects: "${{ needs.build.outputs.digests }}"
      upload-assets: true 