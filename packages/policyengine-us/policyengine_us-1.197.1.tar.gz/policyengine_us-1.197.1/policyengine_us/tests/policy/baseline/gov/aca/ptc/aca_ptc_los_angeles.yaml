# Two 2022 integration tests (one for each LA rating area):

- name: aca_ptc_los_angeles test 22-15
  absolute_error_margin: 0.001
  period: 2022
  input:
    people:
      person1:
        age: 50
        employment_income: 40_000
        is_aca_eshi_eligible: false
      person2:
        age: 45
        employment_income: 30_000
        is_aca_eshi_eligible: false
      person3:
        age: 15
        is_aca_eshi_eligible: false
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_fips: 6  # CA
        county_fips: 37  # Los Angeles County has two zip3-defined rating areas
        aca_zip3_ca_county_la: 911  # e.g., Pasadena (91105)
  output:
    tax_unit_medicaid_income_level: 3.0395136  # greater than 2.66 CA CHIP limit
    is_medicaid_eligible: [false, false, false]
    is_aca_ptc_eligible: [true, true, true]
    aca_slspc_ca: 12_476  # same as 2022 KFF ACA calculator
    aca_magi_fraction: 3.18
    aca_ptc_phase_out_rate: 0.0645
    aca_ptc_ca: 7_961  # $7,947 per 2022 KFF ACA calculator
    # annual contribution amount:  0.0645 * 70000 = 4515
    # PEUS: 12476 - 7961 = 4515
    # KFF:  12476 - 7947 = 4529
    #                        14 diff is a bit more than $1/month 
    # FPL = 21960 (for three in 2021), so exact MAGI/FPL = ~318.76%
    # KFF implied applicable figure is 0.0647, which is between
    #   318 ==> 0.0645  and 319 ==> 0.0648, so it appears as if KFF is
    # not truncating the MAGI/FPL percent as called for on IRS Form 8962

- name: aca_ptc_los_angeles test 22-16
  absolute_error_margin: 0.001
  period: 2022
  input:
    people:
      person1:
        age: 50
        employment_income: 40_000
        is_aca_eshi_eligible: false
      person2:
        age: 45
        employment_income: 30_000
        is_aca_eshi_eligible: false
      person3:
        age: 15
        is_aca_eshi_eligible: false
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_fips: 6  # CA
        county_fips: 37  # Los Angeles County has two zip3-defined rating areas
        aca_zip3_ca_county_la: 904  # e.g., Santa Monica (90405)
  output:
    tax_unit_medicaid_income_level: 3.0395136  # greater than 2.66 CA CHIP limit
    is_medicaid_eligible: [false, false, false]
    is_aca_ptc_eligible: [true, true, true]    
    aca_slspc_ca: 13_160  # same as 2022 KFF ACA calculator
    aca_magi_fraction: 3.18
    aca_ptc_phase_out_rate: 0.0645
    aca_ptc_ca: 8_645  # $8,631 per 2022 KFF ACA calculator
    # annual contribution amount:  0.0645 * 70000 = 4515
    # PEUS: 13160 - 8645 = 4515
    # KFF:  13160 - 8631 = 4529
    #                        14 diff is a bit more than $1/month 
    # KFF implied applicable figure is 0.0647, which is between
    #   318 ==> 0.0645  and 319 ==> 0.0648, so it appears as if KFF is
    # not truncating the MAGI/FPL percent as called for on IRS Form 8962

# Two 2023 integration tests (one for each LA rating area):

# Read the NOTE below the following two tests to understand why they
# are specified the way they are and why an alternative specification
# of these two tests also causes differences between the results
# generated by PolicyEngine-US and the 2023 KFF ACA Calculator.

- name: aca_ptc_los_angeles test 23-15
  absolute_error_margin: 0.001
  period: 2023
  input:
    people:
      person1:
        age: 44
        employment_income: 30_000
        is_aca_eshi_eligible: false
      person2:
        age: 42
        employment_income: 30_000
        is_aca_eshi_eligible: false
      person3:
        age: 12
        is_aca_eshi_eligible: false
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_fips: 6  # CA
        county_fips: 37  # Los Angeles County has two zip3-defined rating areas
        aca_zip3_ca_county_la: 908  # e.g., Long Beach (90805)
  output:
    tax_unit_medicaid_income_level: 2.413516  # less than 2.66 CA CHIP limit
    is_medicaid_eligible: [false, false, true]  # KFF ACA calculator misses this
    is_aca_ptc_eligible: [true, true, false]
    aca_slspc_ca: 8_569  # $10,977 per 2023 KFF ACA calculator (for three)
    aca_magi_fraction: 2.60
    aca_ptc_phase_out_rate: 0.0440
    aca_ptc_ca: 5_929  # $8,325 per 2023 KFF ACA calculator (for three)
    # annual contribution amount:  0.044 * 60000 = 2640
    # PEUS:  8569 - 5929 = 2640
    # KFF:  10977 - 8325 = 2652
    #                        12 diff is $1/month
    # FPL = 23030 (for three in 2022), so exact MAGI/FPL = ~260.53%
    # KFF implied applicable figure is 0.0442, which is half way between
    #   260 ==> 0.0440  and 261 ==> 0.0444, so it appears as if KFF is
    # not truncating the MAGI/FPL percent as called for on IRS Form 8962

- name: aca_ptc_los_angeles test 23-16
  absolute_error_margin: 0.001
  period: 2023
  input:
    people:
      person1:
        age: 44
        employment_income: 30_000
        is_aca_eshi_eligible: false
      person2:
        age: 42
        employment_income: 30_000
        is_aca_eshi_eligible: false
      person3:
        age: 12
        is_aca_eshi_eligible: false
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_fips: 6  # CA
        county_fips: 37  # Los Angeles County has two zip3-defined rating areas
        aca_zip3_ca_county_la: 905  # e.g., Torrance (90505)
  output:
    tax_unit_medicaid_income_level: 2.413516  # less than 2.66 CA CHIP limit
    is_medicaid_eligible: [false, false, true]  # KFF ACA calculator misses this
    is_aca_ptc_eligible: [true, true, false]
    aca_slspc_ca: 9_039  # $11,579 per 2023 KFF ACA calculator (for three)
    aca_magi_fraction: 2.60
    aca_ptc_phase_out_rate: 0.0440
    aca_ptc_ca: 6_399  # $8,927 per 2023 KFF ACA calculator (for three)
    # annual contribution amount:  0.044 * 60000 = 2640
    # PEUS:  9039 - 6399 = 2640
    # KFF:  11579 - 8927 = 2652
    #                        12 diff is $1/month
    # FPL = 23030 (for three in 2022), so exact MAGI/FPL = ~260.53%
    # KFF implied applicable figure is 0.0442, which is half way between
    #   260 ==> 0.0440  and 261 ==> 0.0444, so it appears as if KFF is
    # not truncating the MAGI/FPL percent as called for on IRS Form 8962

# NOTE on the above two tests:
# In the above two tests, the three-person tax unit has an income
# low enough for the twelve-year-old child to be eligible for CHIP
# in California.  If we had specified the tax unit to include just
# the two adults, PolicyEngine-US would have produced the same SLSPC
# amount as produced by the KFF ACA Calculator.  But apparently
# there is no way to tell the KFF ACA Calculator that the two-person
# ACA health insurance unit is part of a three-person tax unit.
# Given that, the KFF ACA Calculator assumes a two-person tax unit,
# and hence, produces a MAGI/FPL percent that is too high.  This
# leads to an overestimate of the annual contribution amount and
# leads to an underestimate of the PTC.  We have decided to use the
# KFF ACA Calculator in a way that makes it easier to understand the
# differences in the results.
#
# It is important to understand that pointing out these differences
# is not meant to be a criticism of the KFF ACA Calculator.  On the
# contrary, the collection of KFF ACA Calculators (going back almost
# to the start of the ACA) is a unique resource for historical data
# on the pricing of second-lowest-cost ACA silver plans.  It would be
# only a modest exaggeration to characterize the KFF ACA Calculators
# as a national treasure.
