"use strict";(self.webpackChunkchartfactor_jlab_ext=self.webpackChunkchartfactor_jlab_ext||[]).push([[568],{774:(e,t,o)=>{o.d(t,{Z:()=>l});var s=o(138),a=o(439);const n=function(e,t){"string"!=typeof e&&(e=e.toString()),"string"!=typeof t&&(t=JSON.stringify(t)),localStorage.setItem(e,t)},i=function(e,t){let o=localStorage.getItem(e);if(null!==o)try{o=JSON.parse(o)}catch(e){}return null===o&&void 0!==t?t:o};var c=o(797);const r=(e=null,t,o)=>{const s=o.currentWidget;return!!e&&!1!==e.activate&&s&&t.shell.activateById(s.id),s};var d=o(824);class l{constructor(e,t){this.app=e,this.notebook=t,this.kernel=null,window.syncWithStudio=!0,window.currentApp=this.app,window.currentNotebook=this.notebook,window.souldDisplaySaveMessage=!0}createTempIframe(e="https://chartfactor.com/studio/jupyter.html",t,o){let s=document.getElementById(t.id);if(s)o(t,s);else{s=document.createElement("iframe");try{s.id=t.id,s.name=t.id,s.src=`${e}jupyter.html`,s.style.display="none",s.addEventListener("load",(function(){o(t,this)})),document.body.appendChild(s)}catch(e){console.error("Oops, unable to create the Iframe element.",e)}}}getCellIframe(e){const t=`iframe${e}_${this.kernel?.id}`;return document.getElementById(t)}setGlobalActiveCellId(e){this.kernel&&this.kernel.requestExecute({code:`cfpy_active_cell_id = '${e}'`,silent:!0})}async onActiveCellChanged(e){e.activeCell&&this.setGlobalActiveCellId(e.activeCell.model.id)}getStudioAppForAllCells(){const e=this.getNotebookConfig();for(const t of e.cells)if("code"===t.cell_type){const e=this.getCellIframe(t.execution_count);e&&e.contentWindow.postMessage({action:"getStudioApp",appId:`cfs.app-${t.id}`},"*")}}async onSave(e,t){const o=r(null,this.app,this.notebook);if(o)switch(this.toJSON||(this.toJSON=o.model.toJSON),t){case"started":window.syncWithStudio&&this.getStudioAppForAllCells();const e=o.model.toJSON(o.model);o.model.toJSON=(e=>()=>{let t=!1;return e.cells.forEach((e=>{if("code"===e.cell_type){const o=i(`cfs.app-${e.id}`);if(o){const s=(e=>{const t=i("cfs.dataProviders"),o=(0,a.uniqBy)(e.widgetList.map((e=>(0,a.get)(e,"source.provider.name",null))).filter((e=>e)));return t.filter((e=>!!o.includes(e.name)&&(e.customCode&&delete e.customCode,e.metadata&&delete e.metadata,!0)))})(o);(0,a.has)(e.metadata,"cf_studio_app")||(e.metadata.cf_studio_app={}),(0,a.has)(e.metadata,"cf_studio_providers")||(e.metadata.cf_studio_providers=[]),e.metadata.cf_studio_app[`cfs.app-${e.id}`]=o,e.metadata.cf_studio_providers=(0,a.uniqBy)([...s],"name"),t=!0}}})),t&&window.souldDisplaySaveMessage&&c.INotification.success("The cf.studio apps were saved into this notebook"),e})(e);break;case"completed":o.model.toJSON=this.toJSON,window.syncWithStudio=!0,window.souldDisplaySaveMessage=!0,delete this.toJSON}}async cfsJlabSynchronizeMessageEventListener(e){"getStudioApp"===e.data.action&&e.data.studioAppId&&(n(e.data.studioAppId,e.data.studioApp),n("cfs.dataProviders",e.data.studioAppProviders),window.syncWithStudio=!1,window.souldDisplaySaveMessage=!1,await this.currentApp.commands.execute("docmanager:save"))}sendPostMessageToStudio(e,t){if(e.metadata.cf_studio_app){const o=_.keys(e.metadata.cf_studio_app);o&&o.length>0&&(e.metadata.cf_studio_app[o[0]].creationDate=Date.now(),t.contentWindow.postMessage({action:"saveStudioApp",storageKey:o[0],storageItem:e.metadata.cf_studio_app[o[0]]},"*"))}e.metadata.cf_studio_providers&&t.contentWindow.postMessage({action:"saveStudioApp",storageKey:"cfs.dataProviders",storageItem:e.metadata.cf_studio_providers},"*"),setTimeout((()=>{document.body.removeChild(t)}),1)}getIframeUrl(e){let t;return e.source.split("\n").forEach((e=>{if(e.includes("cf.studio")){const o=e.match("studio\\((\\s?)+(app=)?[\\'\\\"](.*)[\\'\\\"]\\,(\\s?)+(url=)?[\\'\\\"](.*?)[\\'\\\"]\\)");o?(t=o[6],t&&t.startsWith("http")&&(t=t.trim(),t=t.replace(/\/?$/,"/"))):t="https://chartfactor.com/studio/"}})),t}sendCfsInfoToStudio(e){this.createTempIframe(this.getIframeUrl(e),e,this.sendPostMessageToStudio)}synchronizeNotebook(e){for(const t of e.cells)"code"===t.cell_type&&(0,a.get)(t.metadata,"cf_studio_app")&&(this.sendCfsInfoToStudio(t),this.setGlobalActiveCellId(t.id))}getNotebookConfig(){const e=r(null,this.app,this.notebook);return e.model.toJSON(e.model)}removeFromLocalStorage(e){var t;t=`cfs.app-${e.id}`,localStorage.removeItem(t),this.createTempIframe(this.getIframeUrl(e),e,((e,t)=>{t.contentWindow.postMessage({action:"removeStudioApp",storageKey:`cfs.app-${e.id}`},"*"),setTimeout((()=>{document.body.removeChild(t)}),1)}))}createNew(e,t){try{window.removeEventListener("message",window.cfsJlabSynchronizeMessageEventListener,!1)}catch(e){}return window.addEventListener("message",window.cfsJlabSynchronizeMessageEventListener=this.cfsJlabSynchronizeMessageEventListener,!1),t.sessionContext.ready.then((async()=>{this.kernel=t.sessionContext.session.kernel,this.kernel.connectionStatusChanged.connect(((e,o)=>{if("disconnected"===o){let e=t.model.toJSON(t.model);for(const t of e.cells)if("code"===t.cell_type&&(0,a.get)(t.metadata,"cf_studio_app"))try{this.removeFromLocalStorage(t)}catch(e){this.removeFromLocalStorage(t)}}})),this.synchronizeNotebook(this.getNotebookConfig())})).catch((e=>console.error(e))),d.NotebookActions.executionScheduled.connect((async(e,t)=>{const{cell:o}=t;this.setGlobalActiveCellId(o.model.id)})),t.saveState.connect(this.onSave,this),this.notebook.activeCellChanged.connect(this.onActiveCellChanged,this),new s.DisposableDelegate((()=>{}))}}},568:(e,t,o)=>{o.r(t),o.d(t,{default:()=>r});var s=o(824),a=o(422),n=o(75);const i=o(788).Z,c=o(774).Z,r=[{id:"chartfactor_jlab_ext",autoStart:!0,requires:[s.INotebookTracker,a.ICommandPalette,n.IRenderMimeRegistry],activate:function(e,t,o,s){console.log("JupyterLab extension chartfactor_jlab_ext is activated!");const a=new i,n=new c(e,t);e.docRegistry.addWidgetExtension("Notebook",a),e.docRegistry.addWidgetExtension("Notebook",n)}}]},788:(e,t,o)=>{o.d(t,{Z:()=>n});var s=o(138);class a{constructor(e){this._sessionContext=e,this._future=null,this._kernel_id=void 0}future(e,t=null){this._future=e,e&&(e.onIOPub=e=>{switch(e.header.msg_type){case"execute_result":if(t){const o=e.content.data["text/plain"]||"";t(o)}else t("");break;case"display_data":case"update_display_data":t&&t("");break;case"stream":t(t?e.content.text.trim():"");break;case"error":t&&e.content.ename&&e.content.evalue?("name 'cf' is not defined"===e.content.evalue&&(e.content.evalue="Name 'cf' is not defined. Please execute 'from chartfactor import *' in any cell above."),t(`{"ename": "${e.content.ename}", "evalue": "${e.content.evalue}"}`)):t("")}})}execute(e,t=null){this._sessionContext&&this._sessionContext.session?.kernel||t('{"ename": "KernelOff", "evalue": "It appears that the Jupyter Lab Kernel of this notebook has changed since the last run. Please import chartactor and run the cell again."}'),this.future(this._sessionContext.session?.kernel?.requestExecute({code:e}),t)}}class n{createNew(e,t){const o=new a(t.sessionContext);return t.sessionContext.ready.then((e=>{o._kernel_id=t.sessionContext.session?.kernel?.id,window.JupyterLab||(window.JupyterLab={}),window.JupyterLab[o._kernel_id]={notebook:{kernel:o}}})).catch((e=>console.error(e))),new s.DisposableDelegate((()=>{}))}}}}]);