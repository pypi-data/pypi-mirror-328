<!doctype html><html><head><title>{{title}}</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,viewport-fit=cove"><meta http-equiv="X-UA-Compatible" content="IE=edge">{{contentrefresh|safe}}
<link rel="icon"  href="/static/smartui/img/favicon.ico"><link rel="stylesheet" href="/static/smartchart/js/fun.css?_=1">
<script src="/static/smartchart/js/jquery-2.2.3.min.js"></script>
{% if devhead %}<link rel="stylesheet" href="/static/smartchart/js/dev.css?_=3.1"><link rel="stylesheet" href="/static/smartchart/icon/iconfont.css?_=2"><link rel="stylesheet" href="/static/smartchart/editor/modal.css">{% endif %}
<script src="/static/smartui/js/vue.min.js"></script><link rel="stylesheet" href="/static/smartui/elementui/theme-chalk/index.css"><script src="/static/smartui/elementui/index.js"></script>
<style>
body {background-color: #f1f1f1;width: 100%;}
.el-table--border th.el-table__cell,.el-table__fixed-right-patch {color: #fff; border: none;text-align: center;}
.search_base_div{display:flex;justify-content:center;}
.search_div{background-color: #fff;padding:0.5rem;width:95%;margin-top:0.5rem;border-radius:1rem;}
.body_base_div{display:flex;justify-content:center;}
.body_div{background-color: #fff;padding:0.5rem;width:95%;margin-top:0.5rem;border-radius:1rem;}
.filter_base_div{display:flex;justify-content: center;align-items:center;}
.filter_div{width:99%;display:flex;justify-content: space-between;align-items:center}
.table_base_div{display:flex;justify-content:center;margin-top:1rem;}
.table_div{display:flex;flex-direction:column;}
.tree_div{display:flex;padding:2px;max-height:600px;overflow: auto}
.title{font-size: 12px}
.spot_field{background: #ad120e !important;}
.el-descriptions__header{margin-bottom: 0;}
@media screen and (max-width: 767px) {
  .el-date-picker, .el-date-range-picker {
    width: 100%;
    max-width: none;
    min-width: 0;
    margin-left: 0;
  }
    .title{display: none}
    .el-dialog{width: 98% !important;margin-top: 1vh!important;}
    .el-dialog--center .el-dialog__body{padding: 10px}
    .el-dialog__header{padding: 0; font-size: 12px}
    .el-form-item__label,.el-dialog__title{font-size: 12px}
    .el-form-item{margin-bottom: 10px;}
}

.el-table .caret-wrapper{
    display: none;
    height: 19px;
}
th>.cell:hover .caret-wrapper{
    display: inline-flex ;
}
.el-pagination {overflow: auto}
.el-table--mini .el-table__cell{padding: 2px 0}
.el-upload, .el-button+.el-button{margin-left: 3px}
.el-dialog__headerbtn{top:10px}
.el-alert .el-alert__description{font-size: 14px;color:blue}
.el-checkbox-group{font-size: 18px;display: inline-block}
.el-row:hover .el-input__inner{background: #f5f2f2;}
.btt{height:auto!important;max-height: 90%}

</style>{% block head %}{% endblock %}</head>
{% autoescape off %}{{linkhead}}{{devhead}}{% block body %}
<body>
<vue id="vue_app"  v-loading.fullscreen.lock="!startRender">
{% for div in div_list %}{{div}}{% endfor %}
<vue id="crud_body" :class="smtdrag?'smtdrag':''">
<!--筛选功能行-->
{% block body_search %}
<div class="search_base_div"  v-if="searchHead" ><div class="search_div"><div style="display:flex;" v-if="startRender" id="partSearch1"></div></div></div>
{% endblock %}
{% block body_addHead %}
<div class="search_base_div"  v-if="addHead&&Object.keys(form).length>0"><div class="search_div"><div style="display:flex;" v-if="startRender"><el-form ref="form" :model="form" :rules="rules" :label-width="formLabelWidth" :inline="true" size="mini" id="modifyForm1"></el-form></div></div></div>
{% endblock %}
{% block body_extHead %}{% endblock %}
<!--表格体-->
<div class="body_base_div">
<div class="body_div"  v-if="startRender">
    <!--表格功能行-->
    <div class="filter_base_div">
        <div class="filter_div"><span class="title">{[title]}</span>
        <div>
        {% block body_filter %}<template v-if="!searchHead" id="partSearch2"></template>{% endblock %}
        <template id="partFilter"></template>
         </div>
        </div>
    </div>
    <!--表格容器-->
    <div class="table_base_div">
    {% block body_tree %}
    <div class="tree_div"  v-if="tree_ds" :style="'width:'+treeWidth">
      <el-tree :data="tree_data"  @node-click="handleNodeClick"></el-tree>
    </div>
    {% endblock %}
     <div class="table_div" :style="'width:'+tableWidth">
       {% block body_table %}
       <el-table
        :data="tableData"
        size="mini"
        :header-cell-style="{ background: tableHeaderColor}"
        :header-cell-class-name="tableHearderClassName"
        :row-class-name="tableRowClassName"
        :stripe="stripe"
        :show-summary="showSummary"
        border
        ref="multipleTable"
        :span-method="spanMethod"
        :max-height="maxheight"
        highlight-current-row
        @current-change="handleRowClickChange"
        @selection-change="handleSelectionChange"
        lazy
        :row-key="tree_id?'treeid':''"
        :load="loadTree"
        style="width: 100%;">
      <el-table-column type="expand" v-if="shortTableFields" id="partShort"></el-table-column>
        <el-table-column type="index" v-if="showIndex" width="50"></el-table-column>
        <!--自定义选择列-->
        <el-table-column type="selection" width="55" v-if="actionDict" key="1"></el-table-column>
        <!--自动列-->
       {% block body_table_columns %}
        <el-table-column  v-for="item in (shortTableFields||tableFields||tableHead)"  :label="nameDict[item]||item" :width="widthDict[item]" :align="alignDict[item]||'center'" :prop="item" :key="item" :sortable="!mergeFields" show-overflow-tooltip :fixed="fixedFields.includes(item)">
          <template slot-scope="scope" v-if="scope.row[item]">
              <span v-if="tagFields.includes(item)">
              <el-tag  v-for="v in scope.row[item].split(',')" :color="statusColor[v]" style="color:black" disable-transitions>{[v]}</el-tag>
              </span>
              <el-image v-else-if="typeDict[item]==='img'" :src="construct_img(scope.row[item])" :preview-src-list="[construct_img(scope.row[item])]" lazy></el-image>
              <el-link v-else-if="typeDict[item]==='file'" type="success" :href="construct_img(scope.row[item])" target="_blank">{[scope.row[item]]}</el-link>
              {% block body_table_column %}{% endblock %}
              <span  v-else>{[ scope.row[item]]}</span>
          </template>
        </el-table-column>
        {% endblock %}
        <!--自定义操作列-->
        <el-table-column  :fixed="widthDict.OP?null:'right'" :label="nameDict.OP||'OP'" :width="widthDict.OP||80" v-if="btnEdit||btnRequest||btnView||delete_id" key="2">
          <template slot-scope="scope">
            <el-button type="text" size="mini" icon="el-icon-edit-outline" @click.stop="handleRequestClick(scope.row)" v-if="btnRequest"></el-button>
            <el-button type="text" size="mini" icon="el-icon-edit" @click.stop="handleEditClick(scope.row)" v-if="btnEdit"></el-button>
            <el-button type="text" size="mini"  icon="el-icon-view" @click.stop="handleViewClick(scope.row)" v-if="btnView"></el-button>
           <el-popconfirm title="确认删除?"  @confirm='handleDeleteClick(scope.row)' v-if="delete_id"><el-button type="text" size="mini"  icon="el-icon-delete" slot="reference"></el-button></el-popconfirm>
            {% block body_table_column_button %}{% endblock %}
          </template>
        </el-table-column>
       </el-table>
       <!--分页控件-->
       <el-pagination   align='center' v-if="pageSize<999" @size-change="handlerSizeChange" @current-change="handlerCurrentChange" :current-page="currentPage" :page-size="pageSize" layout="total,sizes,prev,pager,next,jumper" :total="total"></el-pagination>
      {% endblock %}
    </div>
    </div>
</div>
</div>
</vue>
<!--新增修改页-->
{% block dialog_modify %}<el-dialog :title="title" :visible.sync="dialogFormVisible" :width="dialogWidth" :fullscreen="dialogFull" center v-if="!addHead"><el-form ref="form" :model="form" :rules="rules" :label-width="formLabelWidth" id="modifyForm2"></el-form><div slot="footer" class="dialog-footer"><el-button @click="dialogFormVisible = false" icon="el-icon-circle-close"></el-button><el-button :disabled="isClicked" type="primary" @click.stop="update_data" icon="el-icon-success"></el-button></div></el-dialog>{% endblock %}
<!--卡片页-->
{% block dialog_card %}
<el-dialog  :visible.sync="dialogTableVisible"  :width="dialogWidth" id="partCard">
</el-dialog>
{% endblock %}
<!--申批修改页-->
{% block dialog_request %}
<el-dialog :title="title+':变更需求'" :visible.sync="dialogFormVisible_r" :width="dialogWidth" id="partRequest">
</el-dialog>
{% endblock %}
    {% if devhead %}<el-drawer title="CRUD设定"  :visible.sync="dialogSetupVisible" direction="btt"  :with-header="false" v-if="startRender" :modal="false" id="partSetup"></el-drawer>{% endif %}
</vue>
</body>
{% endblock %}{% endautoescape %}
</html><script>const dashid={{ dashid }};const dsDict={{ dsdict|safe }};</script><script src="/static/smartchart/js/flexible.min.js"></script><script src="/static/_dev/js/fun.js?_=5"></script>
{{footer|safe}}<script>
let modifyForm=`<el-form-item v-for="(value, key) in form" :prop="key" :label="nameDict[key]||key">
<el-input v-if="typeDict[key]=='text'" v-model="form[key]" type="textarea" autosize :disabled="constF.includes(key)"></el-input>
<el-date-picker v-else-if="typeDict[key]=='date'" v-model="form[key]" type="date" value-format="yyyy-MM-dd" :disabled="constF.includes(key)"></el-date-picker>
<el-date-picker v-else-if="typeDict[key]=='month'" v-model="form[key]" type="month" value-format="yyyy-MM" :disabled="constF.includes(key)"></el-date-picker>
<el-upload v-else-if="typeDict[key]=='file'||typeDict[key]=='img'" :data="{'typename':dashid,'path':uploadpath, 'key':key}" action="/echart/upload_file/" :on-success="handleUpload" :before-upload="beforeUpload" :inline="true" :show-file-list="false" style="display: inline-block;" :disabled="constF.includes(key)">
<el-button size="mini" style="background-color:#6e8665;border: none;color:#fff" icon="el-icon-upload2"></el-button><span>{[form[key]]}</span></el-upload>
<el-radio-group v-else-if="typeDict[key]=='radio'" v-model="form[key]" :disabled="constF.includes(key)" @input="selectChange(key)">
    <el-radio v-for="item in optionDict2[key]" :key="item[0]" :label="item.join('-')" :value="item[0]"></el-radio>
  </el-radio-group>
<el-select v-else-if="['select','selects'].includes(typeDict[key])" :remote="remoteDsDict[key]" :remote-method="(q)=>{remoteMethod(q,key)}" :loading="loadingDict[key]" v-model="form[key]" :multiple="typeDict[key]=='selects'" filterable clearable @change="selectChange(key)" :disabled="constF.includes(key)">
<el-option v-for="item in optionDict2[key]" :key="item[0]" :label="item.join('-')" :value="item[0]"></el-option></el-select>
 <el-autocomplete v-else-if="remoteDsDict[key]" size="mini"  clearable v-model="form[key]" :fetch-suggestions="(q,c)=>{querySearch(q,c,key)}"   @change="selectChange(key)" :disabled="constF.includes(key)">
 <template slot-scope="{ item }"><span style="margin-right:3px" v-for="item1 of item">{[item1]}</span></template></el-autocomplete>
<el-input v-else-if="typeDict[key]=='number'" type="number" step="any" v-model="form[key]"  :disabled="constF.includes(key)"></el-input>
<el-input v-else v-model.trim="form[key]" autocomplete="off" :disabled="constF.includes(key)" clearable></el-input></el-form-item>`;
let part=document.getElementById("modifyForm1");
if(part){
part.innerHTML=modifyForm+`<el-button :disabled="isClicked" type="primary" @click.stop="update_data" icon="el-icon-success" size="mini">{[modifyFlag===0?'新增':'修改']}</el-button>`;
}
part=document.getElementById("modifyForm2");if(part){part.innerHTML=modifyForm}
part=document.getElementById("partRequest");
if(part) {
part.innerHTML = `<el-form ref="rform" :model="rform" :rules="rules" :label-width="formLabelWidth">
<el-form-item  prop="code" label="主键" required><el-input  v-model="rform.code" autocomplete="off" disabled></el-input></el-form-item>
<el-form-item  prop="columnname" label="列名" required>
  <el-select  v-model="rform.columnname" @change="rform_select_change"><el-option v-for="(value, key) in nameDict" :key="key" :label="value" :value="key"></el-option></el-select>
</el-form-item>
<el-form-item  prop="oldvalue" label="旧值"><el-input  v-model="rform.oldvalue" autocomplete="off" disabled></el-input></el-form-item>
<el-form-item  prop="newvalue" label="新值" required><el-input  v-model.trim="rform.newvalue" autocomplete="off"></el-input></el-form-item>
<el-form-item  prop="request_remark" label="备注"><el-input  v-model="rform.request_remark" autocomplete="off"></el-input></el-form-item>
</el-form>
<div slot="footer" class="dialog-footer">
<el-button @click="dialogFormVisible_r = false" icon="el-icon-circle-close"></el-button>
<el-button  type="primary" :disabled="isClicked" @click.stop="update_data_r" icon="el-icon-success"></el-button>
</div>`;
`    <el-descriptions   size="mini" border :column="3">
    <el-descriptions-item v-for="(value,item) in detail[0]" :key="item" :label="nameDict[item]||item">
     <el-tag v-if="tagFields.includes(item)" :color="statusColor[value]" style="color:black" disable-transitions size="mini">{[value]}</el-tag>
    <el-image v-else-if="value&&typeDict[item]==='img'" :src="construct_img(value)" style="width: 100px" :preview-src-list="[construct_img(value)]" lazy></el-image>
    <span v-else>{[value]}</span>
    </el-descriptions-item>
</el-descriptions>`
}
part = document.getElementById("partCard");
if(part) {
part.innerHTML = `<el-descriptions   size="mini" :column="3" border>
<el-descriptions-item v-for="(value,item) in detail[0]" :key="item" :label="nameDict[item]||item">
 <el-tag v-if="tagFields.includes(item)" :color="statusColor[value]" style="color:black" disable-transitions size="mini">{[value]}</el-tag>
<el-image v-else-if="value&&typeDict[item]==='img'" :src="construct_img(value)" style="width: 100px" :preview-src-list="[construct_img(value)]" lazy></el-image>
<span v-else>{[value]}</span>
</el-descriptions-item>
</el-descriptions>`
}
let searchForm=`<el-checkbox-group v-if="dmFields" v-model="checkedFields" @change="handleCheckedChange"  size="mini"><el-checkbox-button v-for="item in dmFields" :label="nameDict[item]||item" :key="item" ></el-checkbox-button></el-checkbox-group>
<template v-for="(value, key) in searchDict"><el-date-picker v-if="typeDict[key]=='date'" v-model="searchDict[key]" type="daterange" :start-placeholder="nameDict[key]||key" end-placeholder="Period" size="mini" style="width:200px" value-format="yyyy-MM-dd" @change="change()"></el-date-picker>
    <el-date-picker v-else-if="typeDict[key]=='month'" v-model="searchDict[key]" type="monthrange" :start-placeholder="nameDict[key]||key" end-placeholder="Period" size="mini" style="width:200px" value-format="yyyy-MM" @change="change()"></el-date-picker>
    <el-select  v-else-if="['select','selects','radio'].includes(typeDict[key])" :remote="remoteDsDict[key]" :remote-method="(q)=>{remoteMethod(q,key)}" :loading="loadingDict[key]" v-model="searchDict[key]" :multiple="typeDict[key]=='selects'" collapse-tags :style="{width:inputWidth}" :placeholder="nameDict[key]||key" size="mini" clearable filterable @change="change()">
<el-option v-for="item in optionDict2[key]" :key="item[0]" :label="item.join('-')" :value="item[0]"></el-option></el-select><el-autocomplete v-else-if="remoteDsDict[key]" size="mini" :style="{width:inputWidth}" suffix-icon="el-icon-search" clearable v-model="searchDict[key]" :fetch-suggestions="(q,c)=>{querySearch(q,c,key)}" :placeholder="nameDict[key]||key" @change="change">
 <template slot-scope="{ item }"><span style="margin-right:3px" v-for="item1 of item">{[item1]}</span></template></el-autocomplete>
<el-input v-else v-model.trim="searchDict[key]" prefix-icon="el-icon-search" autocomplete="off" :placeholder="nameDict[key]||key"  :style="{width:inputWidth}" size="mini" clearable @change="change()"></el-input>
</template><el-button size="mini" v-if="btnSearch" style="background-color:#66b1ff;border: none;color:#fff" @click="search" icon="el-icon-search"></el-button><el-button size="mini" v-if="btnDownload" style="background-color:#66b1ff;border: none;color:#fff" @click='daochu' icon="el-icon-download"></el-button><el-button size="mini" v-if="btnAdd" style="background-color:#ff9900;border: none;color:#fff" @click='handleAdd' icon="el-icon-circle-plus-outline"></el-button>
<el-upload v-if="uploadds>0" :data="{'typename':dashid,'d':uploadds}" action="/echart/upload_file/" :on-success="handleUpload" :before-upload="beforeUpload" :inline="true" :show-file-list="false" style="display: inline-block;"><el-button size="mini" style="background-color:#6e8665;border: none;color:#fff" icon="el-icon-upload2"></el-button></el-upload>`;
part=document.getElementById("partSearch1");
if(part) {part.innerHTML = searchForm;}
part=document.getElementById("partSearch2");
if(part) {part.innerHTML = searchForm;}
part=document.getElementById("partFilter");
if(part) {
part.innerHTML = `<template v-for="(value, key) in filterDict" >
<el-date-picker v-if="typeDict[key]=='date'" v-model="filterDict[key]" type="date"  size="mini" :style="{width:inputWidth}" :placeholder="nameDict[key]||key" value-format="yyyy-MM-dd" clearable @change="data_filter()"></el-date-picker>
<el-date-picker v-else-if="typeDict[key]=='month'" v-model="filterDict[key]" type="month"  size="mini" :style="{width:inputWidth}" :placeholder="nameDict[key]||key" value-format="yyyy-MM" clearable @change="data_filter()"></el-date-picker>
<el-select  v-else-if="['select','selects','radio'].includes(typeDict[key])" :remote="remoteDsDict[key]" :remote-method="(q)=>{remoteMethod(q,key)}" :loading="loadingDict[key]" v-model="filterDict[key]"  :style="{width:inputWidth}" :placeholder="nameDict[key]||key" size="mini" clearable filterable @change="data_filter()" >
    <el-option v-for="item in optionDict2[key]" :key="item[0]" :label="item[0]" :value="item[0]"></el-option>
</el-select>
<el-input v-else v-model="filterDict[key]" autocomplete="off" :placeholder="nameDict[key]||key"  :style="{width:inputWidth}" size="mini" clearable @input='data_filter()'></el-input>
</template>
<el-popconfirm v-for="(value, key) in actionDict" :title="'execute:'+value[0]+'?'"  @confirm='action_batch(key)'>
<el-button slot="reference" :disabled="isClicked"  size="mini" :style="{background:value[1],border:'none',color:'#fff'}" >{[value[0]]}</el-button>
</el-popconfirm>`;}
part=document.getElementById("partShort");
if(part) {
part.innerHTML =`<template slot-scope="scope">
<el-descriptions  :column="3" size="mini"  border>
<el-descriptions-item v-for="item in (tableFields||tableHead)" :key="item" :label="nameDict[item]||item" >
<el-tag v-if="tagFields.includes(item)" :color="statusColor[scope.row[item]]" style="color:black" disable-transitions size="mini">{[scope.row[item]]}</el-tag>
<el-image v-else-if="scope.row[item]&&typeDict[item]==='img'" :src="construct_img(scope.row[item])" style="width: 100px" :preview-src-list="[construct_img(scope.row[item])]" lazy></el-image>
<span v-else>{[scope.row[item]]}</span>
</el-descriptions-item>
</el-descriptions>
</template>`}
part = document.getElementById("partSetup");
if(part) {
part.innerHTML=`<div style="padding: 10px"><el-form :model="setupform" ref="setupform"  size="mini" :inline="true"><el-tabs tab-position="left">
<el-tab-pane  v-for="(v1,k1) in setupPanel" :label=v1><el-form-item  v-for="(v, k) in setupform" v-if="v.p==k1" :label="v.label">
<el-switch v-if="v.type=='switch'" v-model="setupform[k].value" :disabled="diyKeys.includes(k)"></el-switch>
<el-color-picker v-else-if="v.type=='color'" v-model="setupform[k].value" :disabled="diyKeys.includes(k)"></el-color-picker>
<el-input v-else-if="v.type=='input'" v-model="setupform[k].value" autocomplete="off" :placeholder="v.placeholder" :disabled="diyKeys.includes(k)"></el-input>
<el-input v-else-if="['input_list','input_dict','text_dict','text_dict2'].includes((setupKeyDict[k]||v.type))"  v-model="setupform[k].value" autocomplete="off" :placeholder="v.placeholder" :disabled="diyKeys.includes(k)"><template slot="suffix"><i class="el-icon-edit el-input__icon" @click="openDevDialog(k)" ></i></template></el-input>
<el-input v-else-if="v.type=='number'" type="number" v-model="setupform[k].value" style="width:60px" autocomplete="off" :placeholder="v.placeholder" :disabled="diyKeys.includes(k)"></el-input>
</el-form-item><div><el-button type="info" size="small" @click="save_crud(false)">预览</el-button><el-button type="warning" size="small" @click="save_crud(1)">保存</el-button><el-button type="danger" size="small" @click="save_crud(2)">发布</el-button></div>
</el-tab-pane><el-tab-pane label="模型管理"><el-row><el-input v-model="tableName" size="mini" style="width:150px" prefix-icon="el-icon-search" placeholder="输入表名[可选]"></el-input><el-button @click.prevent="searchfieldList" size="mini">查询</el-button>
<el-button @click.prevent="viewfieldList" size="mini">预览</el-button><el-button @click.prevent="save_crud(1)" size="mini">保存</el-button><el-popconfirm v-if="tableName" con-color="red" title="确认执行数据库操作,这是不可恢复的" @confirm="savefieldList"><el-button slot="reference" size="mini">执行</el-button></el-popconfirm>
</el-row><el-row  style="font-size: 12px" :gutter="5"><el-col :span="3">字段名</el-col><el-col :span="3">备注</el-col><el-col :span="2">实际类型</el-col><el-col :span="1">默认</el-col><el-col :span="1">空</el-col>
<el-col :span="2">类型</el-col><el-col :span="2">对齐</el-col><el-col :span="2">宽度</el-col><el-col :span="6"><el-col :span="3">只读</el-col><el-col :span="3">新增</el-col><el-col :span="3">修改</el-col><el-col :span="3">必填</el-col>
<el-col :span="3">查询</el-col><el-col :span="3">过滤</el-col><el-col :span="3">长显</el-col><el-col :span="3">短显</el-col></el-col></el-row>
<div style="height: 50%"><el-row v-for="item in fieldList" :gutter="5" style="margin-bottom: 2px;" v-if="item.flag!==2"><el-col :span="3"><el-input v-model="item.name" size="mini"></el-input></el-col>
<el-col :span="3"><el-input v-model="item.comment" size="mini"></el-input></el-col><el-col :span="2"><el-input v-model="item.actualtype" size="mini"></el-input></el-col><el-col :span="1"><el-input v-model="item.default" size="mini"></el-input></el-col><el-col :span="1"><el-checkbox v-model="item.isnull" size="mini"></el-checkbox></el-col>
<el-col :span="2"><el-select v-model="item.type" size="mini" clearable><el-option  key="radio" label="单选" value="radio"></el-option><el-option  key="select" label="选择" value="select"></el-option><el-option  key="selects" label="多选" value="selects"></el-option>
<el-option  key="number" label="数字" value="number"></el-option><el-option  key="date" label="日期" value="date"></el-option><el-option  key="month" label="月份" value="date"></el-option><el-option  key="text" label="长文本" value="text"></el-option><el-option  key="file" label="文件" value="file"></el-option>
<el-option  key="img" label="图片" value="img"></el-option></el-select></el-col>
<el-col :span="2"><el-select v-model="item.align" size="mini" clearable><el-option  key="left" label="左" value="left"></el-option><el-option  key="right" label="右" value="right"></el-option></el-select></el-col>
<el-col :span="2"><el-input v-model="item.width" size="mini"></el-input></el-col><el-col :span="6"><el-col :span="3"><el-checkbox v-model="item.isconst" size="mini"></el-checkbox></el-col>
<el-col :span="3"><el-checkbox v-model="item.isadd" size="mini"></el-checkbox></el-col><el-col :span="3"><el-checkbox v-model="item.ismodify" size="mini"></el-checkbox></el-col>
<el-col :span="3"><el-checkbox v-model="item.isrequired" size="mini"></el-checkbox></el-col><el-col :span="3"><el-checkbox v-model="item.issearch" size="mini"></el-checkbox></el-col>
<el-col :span="3"><el-checkbox v-model="item.isfilter" size="mini"></el-checkbox></el-col><el-col :span="3"><el-checkbox v-model="item.isshows" size="mini"></el-checkbox></el-col><el-col :span="3"><el-checkbox v-model="item.isshow" size="mini"></el-checkbox></el-col>
</el-col><el-col :span="1"><el-button type="text" @click.prevent="removefieldList(item)" size="mini" icon="el-icon-delete"></el-button></el-col>
</el-row><el-row><el-button type="text" @click.prevent="addfieldList" size="small" icon="el-icon-circle-plus-outline">添加一行</el-button></el-row>
</div></el-tab-pane></el-tabs></el-form></div><div>
<el-dialog  width="60%" :visible.sync="dialogDevFormVisible" :append-to-body="true" :modal="true" :close-on-click-modal="false" :close-on-press-escape="false" :show-close="false">
<el-alert type="info"  :title="devValue.key+devValue.msg" :description="setupform.nameDict.value||tableHead.join(',')" show-icon :closable="false"></el-alert><el-input  type="textarea" autosize v-model="devValue.value"></el-input>
<div slot="footer"><el-button @click="dialogDevFormVisible=false;dialogSetupVisible=true">取消</el-button><el-button type="primary" @click="saveDevValue">确定</el-button></div>
</el-dialog>
</div>
</el-drawer>`;}



var vapp = new Vue({el: '#vue_app', delimiters: ['{[', ']}'],
     data: {
         startRender:false,
         multipleSelection: [],
         dialogTableVisible:false,
         devValue:{key: '', value: '', msg:''},
         diyKeys:[], //用于用户自定义设定项
         diyVars:{}, //用于用户自定义变量
         detail:'',
         title:'数据清单',
         dashid:dashid,
         tableData:[],
         tableHead:[],
         tableFields:'',
         shortTableFields:'',
         fullData:[],
         modifyFlag:0,
         dialogFormVisible: false,
         total:0,
         isBackPage:false, //后端分页
         isClicked:false,
         dialogFormVisible_r:false,
         dialogSetupVisible:false,
         setupform:'',
         clickRow:'',
         maxheight:600, //表格最大高度
         uploadpath:'crud', //上传文件的路径
         searchHead:true,
         addHead:false, //新增显示在头部
         tableHeaderColor:'#475254',
         dialogWidth:'60%',
         dialogFull:false,
         smtdrag:false,

         stripe:false, //斑马纹
         fixedFields:'', //固定行
         showIndex:false, //显示序号
         showSummary:false, //显示合计

         dmFields:'', //维度选择字段清单
         checkedFields:[], //选中的维度字段
         mergeFields:'', //指定要合并的字段
         spotFields:'', //高亮列

         btnDownload:true,
         btnAdd:true,
         btnSearch:true,
         btnEdit:false,
         isEditRequest:false, //编辑是否审批
         btnView:false,
         btnRequest:false,
         currentPage:1,
         pageSize:30,
         formLabelWidth: 'auto', //标签宽
         inputWidth: '100px', //筛选区输入宽
         nameDict:'', //字段与名称的MAP
         typeDict:'', //用于填报页面字段的类型
         form:{}, //当无aform和mform时生效
         aform:'', //新增表单字段
         mform:'', //修改表单字段
         autoform:{}, //自动提交的内容
         rform:{}, //变更请求,tablename,codename,updater请写在数据集中
         constFields:['id'], //定义修改时只读的字段
         constF:[],
         tagFields:'', //显示为tag样式的字段
         widthDict:'', //字段的显示宽度
         alignDict:'', //字段的对齐方式
         optionDict:'', //自定义的字段选项
         optionDict2:{}, //字段选项实际绑定
         filterDict:'', //用于过滤的字段
         actionDict:'', //动作区按钮的定义
         searchDict:'', //用于筛选的字段
         selectDsDict:'', //定义联想查询数据集
         rules: '', //定义字段校验规则
         requiredFields:'', //必填字段
         statusColor: '', //定义tag字段显示的颜色

         table_id:0,
         add_id:1,
         update_id:1,
         audit_id:1,
         detail_id:2,
         action_id:3,
         option_id:'', //筛选字段清单
         tree_id:'', //树形加载数据集
         delete_id:'', //删除用数据集
         uploadds:'', //上传文件的配置数据集
         tree_ds:'', //树形查询区ds id

         fieldList:[],
         tableName:'',

         tree_data:null,
         tableWidth:'99%',
         treeWidth:'150px',

         loadingDict:{}, //辅助加载状态
         remoteDsDict:'', //远程搜索
         selectDsHead:{}, //辅助联动头
         selectParamDict:'', //用于定义联想或联动时需要的传参
         optionParam:'',//刷新option时的传参

         setupKeyDict:{
                form:'input_dict',aform:'input_dict',mform:'input_dict',searchDict:'input_dict',filterDict:'input_dict',
                tableFields:'input_list',shortTableFields:'input_list',diyKeys:'input_list',optionParam:'input_list',
                constFields:'input_list',tagFields:'input_list',requiredFields:'input_list',fixedFields:'input_list',dmFields:'input_list',mergeFields:'input_list',spotFields:'input_list',
                nameDict:'text_dict',widthDict:'text_dict',alignDict:'text_dict',typeDict:'text_dict',statusColor:'text_dict',selectDsDict:'text_dict',remoteDsDict:'text_dict'
            },
     },
     methods: {
        //树形菜单点击
        handleNodeClick(node, data) {
            if(data.isLeaf){
                let param = data.data.param||data.data.id;
                if(param == filter_param._label){param = ''}
                ds_setParam('_label',param);
                this.refreshTable();
                this.data_filter();
            }
       },
         //行合并
         spanMethod({ row, column, rowIndex, columnIndex }) {
              if (this.mergeFields.includes(column.property)) {
                const prevRow = rowIndex === 0?'':this.tableData[rowIndex - 1];
                if (prevRow[column.property] === row[column.property]) {
                  return { rowspan: 0, colspan: 0 };
                } else {
                  let rowspan = 1;
                  let j = rowIndex + 1;
                  while (j < this.tableData.length && this.tableData[j][column.property] === row[column.property]) {
                    j++;
                    rowspan++;
                  }
                  return { rowspan:rowspan, colspan: 1 };
                }
              }
               return { rowspan:1, colspan: 1 };
            },
         //配制转化
         translate_keyValue(type, value){
            if(value && typeof value === 'string') {
                value = value.replace('，',',').replace('：',':');
                if (type==='input_list') {
                    return value.split(',').map(field => field.trim());
                } else if (type==='input_dict') {
                    return value.split(',').reduce((acc, cur) => {acc[cur.trim()] = '';return acc;}, {});
                } else if (type==='text_dict') {
                    return value.split(",").reduce((result, item) => {const [key, value] = item.split(":");result[key.trim()] = value.trim();return result;}, {});
                }else if(type==='text_dict2'){
                   return JSON.parse(value);
                }
                else {
                    return value;
                }
            }
            return value
         },
        refresh_option(){
            if(this.option_id){
                let param={};
                for(let item of this.optionParam){if(this.form[item]){param[item]=this.form[item]}}
                ds_refresh(this.option_id,param);
                let optiondata = eval('data' + this.option_id);
                if(optiondata instanceof Array){
                    optiondata = {df0:optiondata}
                }
                for(let key in optiondata){this.optionDict2[optiondata[key][0][0]]=optiondata[key].slice(1);}
            }

        },

        transfer_config() {
            for(let key in this.setupKeyDict){
                this[key] = this.translate_keyValue(this.setupKeyDict[key], this[key]);
            }
            if (this.requiredFields&&this.requiredFields.length>0) {
                this.rules = this.requiredFields.reduce((acc, cur) => {
                    acc[cur] = [{required: true, message: `请输入${this.nameDict[cur] || cur}`, trigger: 'blur'}];
                    return acc;
                }, {});
            }
            for(let key in this.optionDict){this.optionDict2[key] = this.optionDict[key]}
            this.refresh_option();
            if(this.tree_ds){
                ds_refresh(this.tree_ds);
                let treedata = eval('data' + this.tree_ds);
                this.tree_data = ds_tree(treedata);
            }
            if(this.addHead){
                this.handleAdd();
            }
        },
        construct_img(name){
            return '/static/custom/'+this.uploadpath+'/'+name
         },
        handleViewClick(row) {
            this.dialogTableVisible = true;
            let param={};
            param[this.constFields[0]]=row[this.constFields[0]];
            ds_refresh(this.detail_id,param);
            this.detail = ds_createMap_all(eval('data'+this.detail_id));
         },
        handlerSizeChange(val){
             this.currentPage = 1;
             this.pageSize=val;
              if(this.isBackPage) {
                  this.refreshTable();
                  this.data_filter();
              }else{
                  this.tableData = this.fullData.slice((this.currentPage-1)*this.pageSize, this.currentPage*this.pageSize);
              }
         },
        handlerCurrentChange(val){
             this.currentPage = val;
              if(this.isBackPage) {
                  this.refreshTable();
                  this.data_filter();
              }else{
                  this.tableData = this.fullData.slice((this.currentPage-1)*this.pageSize, this.currentPage*this.pageSize);
              }
         },
        handleSelectionChange(val) {
            this.multipleSelection = val;
        },
        //表格行格式
        tableRowClassName({row, rowIndex}) {return '';},
        tableHearderClassName({row, column, rowIndex, columnIndex}) {
            return this.spotFields.includes(column.property) ? 'spot_field' : ''
        },
        //表格行点击动作
        handleRowClickChange(row) {},
        change(){if(!this.btnSearch){this.search()}},
         //维度点击响应
        handleCheckedChange(){
          for(let item of this.dmFields) {
             if (this.checkedFields.includes(item)) {
                 ds_setParam('_' + item, item);
             } else {
                 ds_setParam('_' + item, '');
             }
          }
          this.refreshTable();
          this.data_filter();
        },
         //树形表格
        loadTree(tree, treeNode, resolve) {
             let param = JSON.parse(JSON.stringify(filter_param));
             let tablehead = this.shortTableFields||this.tableFields||this.tableHead;
             param[tablehead[0]] = tree[tablehead[0]];
             for(let item of this.dmFields) {
                 if (this.checkedFields.includes(item)) {
                     param['_' + item]=tree[item];
                 }
             }
             ds_refresh(this.tree_id, param);
             let ds = eval('data'+this.tree_id);
             ds[0].push('treeid');
             for (let i=1;i< ds.length;i++){
              ds[i].push(ds_generateUUID())
            }
             ds[0][0] = tablehead[0];
             resolve(ds_createMap_all(ds));
         },
         // 共公区
        search(){
          for(let key in this.searchDict){
              if(['date','month'].includes(this.typeDict[key])){
                let order_date = this.searchDict[key];
                ds_setParam(key + '_s', order_date?order_date[0]:'');
                ds_setParam(key + '_e', order_date?order_date[1]:'');
              }else if(this.searchDict[key] instanceof Array){
                ds_setParam(key, this.searchDict[key].map(item =>  "'" + item + "'").join(','));
              }
              else{ds_setParam(key, this.searchDict[key]);}
          }
          this.refreshTable();
          this.data_filter();
        },
         //提交数据
        update_data(){
            this.stopClick();
            this.$refs.form.validate((valid)=>{
                if(valid) {
                    let param={};
                    for(let key in this.form){
                        if(this.modifyFlag&&this.clickRow[key]===this.form[key]){continue}
                        if(this.form[key] instanceof Array){
                            param[key] = this.form[key].join(',')
                        }else{param[key]=this.form[key];}
                    }
                    for(let key in this.autoform){
                        param[key]=this.autoform[key];
                    }
                    if(Object.keys(param).length === 0){this.$message.error('没有任何修改项');return}
                    if(this.modifyFlag){
                        param[this.constFields[0]] = this.clickRow[this.constFields[0]];
                    }
                    if(this.isEditRequest&&this.modifyFlag){
                        this.$prompt('请输入变更原因').then(({ value }) => {
                            delete param[this.constFields[0]];
                           this.rform = {code:this.clickRow[this.constFields[0]],newvalue:JSON.stringify(param), request_remark:value};
                           let res = ds_save(this.audit_id, this.rform);
                           if(res.status==200){
                             this.$message.success('完成提交,等待审核通过 Submitted, Wait for check');
                              this.dialogFormVisible = false;
                           } else{this.$message.error(res.msg);}
                        }).catch(() => {this.$message({type: 'info', message: '取消修改'});});
                    }
                    else {
                        let res = ds_save(this.modifyFlag ? this.update_id : this.add_id, param, this.modifyFlag);
                        if (res.status == 200) {
                            this.$message.success('完成数据保存 Completed Save');
                            this.refreshTable();
                            this.data_filter();
                            this.dialogFormVisible = false;
                        } else {
                            this.$message.error(res.msg);
                        }
                    }
                 }
            });
         },
         //变更申请提交
        update_data_r(){
            this.stopClick();
            this.$refs.rform.validate((valid)=>{
                if(valid) {
                    let res = ds_save(this.audit_id, this.rform);
                    if(res.status==200){
                     this.$message.success('完成提交,等待审核通过 Submitted, Wait for check');
                     this.dialogFormVisible_r = false;
                    }
                   else{this.$message.error(res.msg);}
                 }
            });
         },
        //功能批量处理
        action_batch(action){
            this.stopClick();
            let updatelist=[];
            for(item of this.multipleSelection){
                updatelist.push(item[this.constFields[0]]);
            }
            updatelist=`${updatelist.map(item =>  typeof item !== 'number' ? "'" + item + "'" : item).join(',')}`;
            let param={action:action,updatelist:updatelist,...filter_param};
            ds_refresh(this.action_id,param);
            this.refreshTable();
            this.data_filter();
        },
        handleEditClick(row) {
            if(this.constFields.length<1){this.$message.error('你需要在只读字段中设定第一位为主键');return}
            if(!row.hasOwnProperty(this.constFields[0])){this.$message.error('未找到主键,请确认设定是否正确');return}
            if(!row[this.constFields[0]]){this.handleAdd()}else{
                this.modifyFlag=1;
                this.dialogFormVisible = true;
                this.constF = this.constFields;
                if(this.mform){this.form=this.mform}
                this.clickRow=row;
            }
            for (let key in this.form) {
                if(row[key]&&this.typeDict[key] === 'selects'){this.form[key] = row[key].split(',')}else{this.form[key] = row[key];}
            }
         },
        handleDeleteClick(row){
            let res = ds_save(this.delete_id, [row[this.constFields[0]]], 2);
            if(res.status==200){
             this.$message.success('完成数据删除 Completed Delete');
             this.refreshTable();
             this.data_filter();
            }
           else{this.$message.error(res.msg);}
         },
        handleRequestClick(row) {
            this.dialogFormVisible_r = true;
            this.clickRow=row;
            this.rform = {code:'', columnname:'', oldvalue:'', newvalue:'', request_remark:''};
            this.rform.code=row[this.constFields[0]];
         },
        handleAdd(){
            this.dialogFormVisible = true;
            this.modifyFlag=0;
            if(this.selectDsDict){this.constF = this.constFields.slice(1)}else{this.constF=[];}
            if(this.aform){this.form=this.aform}
            for(let key in this.form) {this.form[key] = "";}
         },
        daochu(){
             let dataset=[];
             let temp=[];
             let tablehead = this.shortTableFields||this.tableFields||this.tableHead;
             for(let item of tablehead){
                 temp.push(this.nameDict[item]||item)
             }
             dataset.push(temp);
             for(let items of this.fullData){
                 temp=[];
                 for(let item of tablehead){
                     temp.push(items[item])
                 }
                 dataset.push(temp)
             }
            ds_download(this.title + '_下载', dataset);
         },
         //数据模糊过滤
        data_filter(){
            let tempData=this.fullData;
            for(let key in this.filterDict){
               if(this.filterDict[key]){
                   let v = this.filterDict[key].trim();
                   let op=v[0];
                   if(['<','=','>','>=','<='].includes(op)){
                       if(v.length<2){return}
                       if(v[1]=='='){op=op+'='}
                       v=v.slice(op.length);
                       if(op=='='){op='=='}
                       let fun=eval(`item => item${op}'${v}'`);
                       tempData = tempData.filter(item => fun(item[key]));
                   }
                   else{
                       let regex = new RegExp(v, 'i');
                       tempData = tempData.filter(item => regex.test(item[key]));
                   }
               }
            }
            if(this.isBackPage){
                this.tableData = tempData;
            }else {
                this.currentPage = 1;
                this.tableData = tempData.slice((this.currentPage-1)*this.pageSize, this.currentPage*this.pageSize);
                this.total = tempData.length;
            }
        },
        stopClick(){
            this.isClicked = true;
            setTimeout(() => {
            this.isClicked = false;
            }, 1000);
        },
        refreshTable(){
            if(this.isBackPage) {
                ds_setParam('limit', this.pageSize);
                ds_setParam('offset', vapp.pageSize * (vapp.currentPage - 1));
            }
            ds_refresh(this.table_id);
            let ds = eval('data'+this.table_id);
            if(this.isBackPage){
                if(ds instanceof Array){
                    this.$message.error('后端分页,查询数据集需带总数');
                    return
                }
                this.total = ds.df0[1][0];
                ds = ds.df1;
            }else{
                this.total = ds.length-1;
            }
            if(this.tree_id){
                    ds[0].push('treeid');
                    ds[0].push('hasChildren');
                   for (let i=1;i< ds.length;i++){
                       ds[i].push(ds_generateUUID());
                       ds[i].push(1);
                   }
                   this.tableHead = ds[0].slice(0, ds[0].length-2);
            }else{this.tableHead = ds[0];}
            this.fullData = ds_createMap_all(ds);
            if(this.isBackPage){
                this.tableData = this.fullData;
            }else{ this.tableData=this.fullData.slice((this.currentPage-1)*this.pageSize, this.currentPage*this.pageSize)}
        },
         //请求修改表单选择联想
        rform_select_change(){
            this.rform.oldvalue=this.clickRow[this.rform.columnname];
        },
         //选择联动
        selectChange(key){
            setTimeout(()=>{
             if(this.optionParam.indexOf(key)>-1){this.refresh_option()}
             let select_id = this.selectDsDict[key];
             if(!select_id){return}
             let value = this.form[key];
             let select_data = [];
             //需要获取那些字段要联动用于自动清空
             if(value||!this.selectDsHead[key]) {
                  //处理多选的情况
                 if (value instanceof Array) {
                     value = value.map(item => "'" + item + "'").join(',');
                 }
                 let param = {};
                 param[key] = value;
                 //额外参数的情况
                 if(this.selectParamDict[key]){
                     for(let item of this.selectParamDict[key]){
                         param[item] = this.form[item]
                     }
                 }
                 ds_refresh(select_id, param);
                 select_data = eval('data' + select_id);
                 this.selectDsHead[key] = [select_data[0]];
             }else{
                 select_data =  this.selectDsHead[key];
             }
             for(let item in this.form) {
                 let i = select_data[0].indexOf(item);
                 if (i > -1) {
                     if (select_data.length > 1) {
                         this.form[item] = select_data[1][i]
                     } else {
                         this.form[item] = null;
                     }
                 }
             }
            },200)
         },
         //远程搜选项
        remoteMethod(q,key){
          if(q){
              this.loadingDict[key] = true;
              let remote_id = this.remoteDsDict[key];
              if(!remote_id){return}
              let param={};
              param[key]=q;
              if(this.selectParamDict[key]){
                  for(let item of this.selectParamDict[key]){
                         param[item] = this.form[item]
                  }
              }
              ds_refresh(remote_id, param);
              this.loadingDict[key] = false;
              this.optionDict2[key] = eval('data' + remote_id).slice(1);
          } else {
              this.optionDict2[key] = [];
          }
        },
         //输入框远程搜
        querySearch(q, cb, key) {
             if(q){
              let remote_id = this.remoteDsDict[key];
              let param={};
              param[key]=q;
              if(this.selectParamDict[key]){
                  for(let item of this.selectParamDict[key]){
                         param[item] = this.form[item]
                  }
              }
              ds_refresh(remote_id, param);
              let mydata = eval('data' + remote_id);
              mydata[0][0] = 'value';
              mydata = ds_createMap_all(mydata);
              cb(mydata);
          } else {
              cb([]);
          }
      },
        handleUpload(response, file, fileList){
         if(response.status===200){
             if(response.key){this.form[response.key]=response.data[0];}else{this.refreshTable()}
             this.$message.success(response.msg);
         }else{this.$message.error(response.msg);}
       },
       beforeUpload(file) {
       // const isExcel = file.type === 'application/vnd.ms-excel' ||
        //  file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
       // if (!isExcel) {
        //  this.$message.error('只能上传Excel文件');
       // }
        const isLt2M = file.size / 1024 / 1024 < 5;
        if (!isLt2M) {
          this.$message.error('文件大小不能超过 5MB!');
        }
        return isLt2M;
      },
     //自定义function
      diyFun(){},
     }
});
</script>{% block javascript %}{% endblock %}{% if devhead %}<script>
$('#id_resetdrag').after('<a class="iconfont iconed_list pro" onclick="showSetup()"></a>');
let fieldListbk;
let connid;
let dbtype;
vapp.dialogDevFormVisible=false;
vapp.saveDevValue=()=>{
      vapp.setupform[vapp.devValue.key].value = vapp.devValue.value;
      vapp.dialogDevFormVisible = false;
      vapp.dialogSetupVisible = true;
};
vapp.openDevDialog=(key) =>{
      vapp.devValue.key = key;
      vapp.devValue.value = vapp.setupform[key].value;
      vapp.devValue.value1 = vapp[key];
      vapp.devValue.msg = vapp.setupform[key].placeholder;
      vapp.dialogSetupVisible = false;
      vapp.dialogDevFormVisible = true;
    };
vapp.setupPanel={
    1:'表格显示',2:'筛选过滤',3:'新增修改',4:'数据管理'
};
vapp.setupform={
    searchHead:{label:'查询头',type:'switch',value:'',default:true,p:2},
    addHead:{label:'新增头',type:'switch',value:'',default:false,p:3},
    btnAdd:{label:'新增',type:'switch',value:'',default:true,p:3},
    btnSearch:{label:'查询',type:'switch',value:'',default:true,p:2},
    btnDownload:{label:'下载',type:'switch',value:'',default:true,p:2},
    btnEdit:{label:'编辑',type:'switch',value:'',default:false,p:3},
    isEditRequest:{label:'审批编辑',type:'switch',value:'',default:false,p:3},
    btnView:{label:'查看',type:'switch',value:'',default:false,p:1},
    btnRequest:{label:'审批',type:'switch',value:'',default:false,p:3},
    dialogFull:{label:'全屏录入',type:'switch',value:'',default:false,p:3},
    isBackPage:{label:'后端分页',type:'switch',value:'',default:false,p:1},
    stripe:{label:'斑马纹',type:'switch',value:'',default:false,p:1},
    showIndex:{label:'显示序号',type:'switch',value:'',default:false,p:1},
    showSummary:{label:'显示合计',type:'switch',value:'',default:false,p:1},

    tableHeaderColor:{label:'表头颜色',type:'color',value:'',default:'#475254',p:1},
    table_id:{label:'表格',type:'number',value:'',default:0,p:4},
    detail_id:{label:'详情',type:'number',value:'',default:2,p:4},
    tree_id:{label:'展开',type:'number',value:'',p:4},
    option_id:{label:'选项',type:'number',value:'',default:'',p:4},
    add_id:{label:'新增',type:'number',value:'',default:1,p:4},
    update_id:{label:'更新',type:'number',value:'',default:1,p:4},
    delete_id:{label:'删除',type:'number',value:'',default:'',p:4},
    uploadds:{label:'导入',type:'number',value:'',p:4},
    audit_id:{label:'审批',type:'number',value:'',default:1,p:4},
    action_id:{label:'功能',type:'number',value:'',default:3,p:4},
    tree_ds:{label:'树区域',type:'number',value:'',p:4},
    selectDsDict:{label:'带出ds映射',value:'',placeholder:"筛选字段时带出与查询数据集的对应关系,逗号分隔如:code:5",p:4},
    remoteDsDict:{label:'选项ds映射',value:'',placeholder:"模糊查询选择与查询数据集的对应关系,逗号分隔如:code:5",p:4},

    title:{label:'标题',type:'input',value:'',p:1},
    nameDict:{label:'字段映射',value:'',placeholder:"中英文对照关系,逗号分隔如:code:编码",p:1},
    searchDict:{label:'查询字段',value:'',placeholder:"字段查询,逗号分隔",p:2},
    filterDict:{label:'过滤字段',value:'',placeholder:"字段模糊过滤,逗号分隔",p:2},
    tableFields:{label:'表格字段',value:'',placeholder:"表头显示的字段,逗号分隔",p:1},
    shortTableFields:{label:'短表格字段',value:'',placeholder:"表头显示的字段,会开启表折叠,逗号分隔",p:1},
    fixedFields:{label:'固定字段',value:'',placeholder:'固定在左边的字段,逗号分隔',p:1},
    mergeFields:{label:'合并字段',value:'',placeholder:'相同数据合并显示的字段,逗号分隔',p:1},
    spotFields:{label:'高亮字段',value:'',placeholder:'表头高亮显示的字段,逗号分隔',p:1},
    aform:{label:'新增字段',value:'',placeholder:"新增页显示的字段,逗号分隔",p:3},
    mform:{label:'修改字段',value:'',placeholder:"修改页显示的字段,逗号分隔",p:3},
    constFields:{label:'只读字段',value:'id',placeholder:"逗号分隔, 注意第一位放主键",p:3},
    requiredFields:{label:'必填字段',value:'',placeholder:"新增修改为必填的,逗号分隔",p:3},
    typeDict:{label:'字段类型',value:'',placeholder:"支持的类型有number,date,month,select,selects,text,file,img,如:status:select",p:2},
    optionDict:{label:'选项定义',type:'text_dict2',value:'',placeholder:'固定选择项,如:{"status":[["A","状态A"],["B"]]}',p:2},
    widthDict:{label:'字段宽度',value:'',placeholder:"列宽度,逗号分隔如:code:100px",p:1},
    alignDict:{label:'字段对齐',value:'',placeholder:"对齐方式,逗号分隔如:code:left",p:1},
    tagFields:{label:'tag字段',value:'',placeholder:"标签类型,逗号分隔",p:1},
    statusColor:{label:'tag颜色',value:'',placeholder:"标签字段的背景颜色,如:有钱:red",p:1},
    inputWidth:{label:'查询框宽',type:'input',value:'',default:'100px',p:2},
    treeWidth:{label:'树区域宽',type:'input',value:'',default:'150px',p:2},
    formLabelWidth:{label:'标签宽度',type:'input',value:'',default:'auto',p:3},
    dialogWidth:{label:'弹出宽度',type:'input',value:'',default:'60%',p:3},
    tableWidth:{label:'表宽度',type:'input',value:'',default:'99%',p:1},
    maxheight:{label:'表格最大高度',type:'input',value:'',default:600,p:1},
    pageSize:{label:'分页条数',type:'input',value:'',default:30,p:1},
    actionDict:{label:'批量动作',type:'text_dict2',value:'',placeholder:'批量动作的按钮,如:{"action1":["动作1","black"]}',p:3},
    optionParam:{label:'选项参数',value:'',placeholder:"填表时刷新固定选项时传参的字段名称,逗号分隔",p:3},
    selectParamDict:{label:'联想参数',type:'text_dict2',value:'',placeholder:'填表时联想字段额外的传参字段,如:{"供应商":["物料","地区"]}',p:3},
    dmFields:{label:'可变维度',value:'',placeholder:'可变更维度字段,逗号分隔',p:2},
};
function showSetup(){
   for(let key in vapp.setupform) {
       if(vapp[key]){
           let type = vapp.setupKeyDict[key]||vapp.setupform[key].type;
            if (type==='input_list') {
                vapp.setupform[key].value = vapp[key].join();
            } else if (type==='input_dict') {
                vapp.setupform[key].value = Object.keys(vapp[key]).join();
            } else if (type==='text_dict') {
                vapp.setupform[key].value = JSON.stringify(vapp[key]).replace(/[{}"]/g, '').replace(/:/g, ':').replace(/,/g, ',');
            } else if(type==='text_dict2'){vapp.setupform[key].value = JSON.stringify(vapp[key])}
            else {
                vapp.setupform[key].value = vapp[key];
            }}
       else{vapp.setupform[key].value = vapp[key];}
        }
   vapp.dialogSetupVisible=true;
}

vapp.save_crud=(save)=>{
    let crud=[];
    for(let key in vapp.setupform) {
        let type = vapp.setupKeyDict[key]||vapp.setupform[key].type;
        vapp[key] = vapp.translate_keyValue(type,vapp.setupform[key].value);
        if(save){
            if(vapp[key]!=vapp.setupform[key].default&&!vapp.diyKeys.includes(key)){
            if(typeof vapp[key]==='string' && typeof vapp.setupform[key].default !== 'number'){
                if(vapp[key]){crud.push(`vapp.${key}='${vapp[key]}'`)}
            }else if(typeof vapp[key]==='object'){
                if(vapp.setupKeyDict[key]){crud.push(`vapp.${key}=\`${vapp.setupform[key].value}\``);}
                else{crud.push(`vapp.${key}=${JSON.stringify(vapp[key])}`)}
            }else{
                crud.push(`vapp.${key}=${vapp[key]}`)
            }
          }
        }
   }
    vapp.transfer_config();
    if(save) {
       if(vapp.remoteDsDict){
           let optionDict2 = {};
           for(let key in vapp.remoteDsDict){optionDict2[key] = ''}
           crud.push(`vapp.optionDict2=${JSON.stringify(optionDict2)}`);
        }
        $.ajax({
            type: "POST",
            async: false,
            url: "/echart/save_smartcrud/",
            data: {dashid: dashid, crud: `\/\/=start_crud=\/\/\n${crud.join(';\n')}\n\/\/=end_crud=\/\/`, save:save},
            success: function (data) {
                vapp.$message.success(data.msg);
            }
        });
    }
};
vapp.removefieldList=(item)=>{
        let index = vapp.fieldList.indexOf(item);
        if (index !== -1) {
          vapp.fieldList[index].name='';
          vapp.fieldList[index].actualtype='';
          vapp.fieldList[index].flag=2;
        }
      };
vapp.addfieldList=()=>{
        vapp.fieldList.push({name:'',comment:'',actualtype:'varchar(50)', default:'',type:'',align:'', width:'', isnull:true, iskey:false,
        isconst:false,isadd:false,ismodify:false,isrequired:false,issearch:false,isfilter:false,isshows:false,isshow:false,flag:1});
      };
vapp.searchfieldList=()=>{
    let fieldList=[];
    let fieldSet=[];
    if(vapp.tableName) {
        $.ajax({
            type: "POST",
            async: false,
            url: "/echart/get_dash_tableColumn/",
            data: {dashid: dashid, table: vapp.tableName},
            success: function (data) {
                if (data.status === 200) {
                    vapp.$message.success(data.msg);
                    fieldList = data.data;
                    fieldListbk=JSON.parse(JSON.stringify(fieldList));
                    connid = data.connid;
                    dbtype = data.dbtype;
                } else {
                    vapp.$message.error(data.msg);
                    return
                }
            }
        });
    }else{
        for(let item of vapp.tableHead) {
            fieldList.push({name: item});
            fieldSet.push(item);
        }
        for(let item in vapp.nameDict){
            if(!fieldSet.includes(item)){fieldList.push({name: item});fieldSet.push(item);}
        }
        for(let item in vapp.aform){
            if(!fieldSet.includes(item)){fieldList.push({name: item});fieldSet.push(item);}
        }
        for(let item in vapp.mform){
            if(!fieldSet.includes(item)){fieldList.push({name: item});fieldSet.push(item);}
        }
        for(let item in vapp.searchDict){
            if(!fieldSet.includes(item)){fieldList.push({name: item});fieldSet.push(item);}
        }
    }
    for (let item of fieldList) {
        if (vapp.nameDict[item.name]) {
            item.comment = vapp.nameDict[item.name]
        }
        item.type = vapp.typeDict[item.name];
        item.align = vapp.alignDict[item.name];
        item.width = vapp.widthDict[item.name];
        item.isconst = vapp.constFields.includes(item.name);
        item.isadd = vapp.aform.hasOwnProperty(item.name);
        item.ismodify = vapp.mform.hasOwnProperty(item.name);
        item.isrequired = vapp.requiredFields.includes(item.name);
        item.issearch = vapp.searchDict.hasOwnProperty(item.name);
        item.isfilter = vapp.filterDict.hasOwnProperty(item.name);
        item.isshows = vapp.tableFields.includes(item.name);
        item.isshow = vapp.shortTableFields.includes(item.name);
    }
    vapp.fieldList = fieldList;
};
//预览生效
vapp.viewfieldList=()=>{
    vapp.typeDict='';
    vapp.alignDict='';
    vapp.widthDict='';
    vapp.constFields='';
    vapp.requiredFields='';
    vapp.aform='';
    vapp.mform='';
    vapp.searchDict='';
    vapp.filterDict='';
    vapp.tableFields='';
    vapp.shortTableFields='';
    for(let item of vapp.fieldList){
        if(item.flag!==2){
            if(item.comment){if(!vapp.nameDict){vapp.nameDict={}}vapp.nameDict[item.name]=item.comment}
            if(item.type){if(!vapp.typeDict){vapp.typeDict={}}vapp.typeDict[item.name]=item.type}
            if(item.align){if(!vapp.alignDict){vapp.alignDict={}}vapp.alignDict[item.name]=item.align}
            if(item.width){if(!vapp.widthDict){vapp.widthDict={}}vapp.widthDict[item.name]=item.width}
            if(item.isconst){if(!vapp.constFields){vapp.constFields=[]}vapp.constFields.push(item.name)}
            if(item.isadd){if(!vapp.aform){vapp.aform={}}vapp.aform[item.name]=''}
            if(item.ismodify){if(!vapp.mform){vapp.mform={}}vapp.mform[item.name]=''}
            if(item.isrequired){if(!vapp.requiredFields){vapp.requiredFields=[]}vapp.requiredFields.push(item.name)}
            if(item.issearch){if(!vapp.searchDict){vapp.searchDict={}}vapp.searchDict[item.name]=''}
            if(item.isfilter){if(!vapp.filterDict){vapp.filterDict={}}vapp.filterDict[item.name]=''}
            if(item.isshows){if(!vapp.tableFields){vapp.tableFields=[]}vapp.tableFields.push(item.name)}
            if(item.isshow){if(!vapp.shortTableFields){vapp.shortTableFields=[]}vapp.shortTableFields.push(item.name)}
            }
    }
    showSetup();
};
function generateCreateTableSql(table, fields) {
  let sql = `CREATE TABLE ${table}(`;
  fields.forEach(field => {
    let fieldSql = field.name + ' ' + field.actualtype;
    if (field.default) {
      fieldSql += ' DEFAULT ' + field.default;
    }
    if (field.name === 'id') {
      fieldSql += ' PRIMARY KEY';
      if(dbtype==='sqlite'){fieldSql += ' AUTOINCREMENT';}else{fieldSql += ' AUTO_INCREMENT';}
    }
    if (field.name === 'create_time') {
        fieldSql += ' DEFAULT CURRENT_TIMESTAMP';
    }
    if (field.name === 'update_time') {
        if(dbtype!=='sqlite'){fieldSql += ' DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP';}
    }
    if(!field.isnull){
        fieldSql += ' not null ';
    }
    if (field.comment && dbtype!=='sqlite') {
      fieldSql += " COMMENT '" + field.comment + "'";
    }
    sql += ' ' + fieldSql +',';
  });
  sql = sql.slice(0, -1); // 去掉最后一个逗号和换行符
  sql += ')';
  return sql;
}
//保存到数据库
vapp.savefieldList=()=>{
    let sqllist=[];
    let s=' ';
    if(!connid){vapp.$message.error('需要先执行查询');return}
    //建表
    if(fieldListbk.length===0){
        sqllist.push(generateCreateTableSql(vapp.tableName,vapp.fieldList));
    }else {
        for (let i = 0; i < fieldListbk.length; i++) {
            let item = vapp.fieldList[i];
            if (item.flag === 2) {
                sqllist.push(`alter table ${vapp.tableName}${s}DROP COLUMN ${fieldListbk[i].name}`)
            } else if (fieldListbk[i].name !== item.name || fieldListbk[i].comment !== item.comment || fieldListbk[i].actualtype !== item.actualtype || fieldListbk[i].default !== item.default|| fieldListbk[i].isnull !== item.isnull) {
                let defaults = item.default ? `default ${item.default}` : '';
                let comment = item.comment ? `comment '${item.comment}'` : '';
                let nullable = item.isnull ? ' null ':' not null ';
                if(dbtype!=='sqlite'){
                   sqllist.push(`alter table ${vapp.tableName}${s}change ${fieldListbk[i].name}${s}${item.name}${s}${item.actualtype}${s}${defaults}${nullable}${comment}`)}
            }
        }
        for (let i = fieldListbk.length; i < vapp.fieldList.length; i++) {
             let item = vapp.fieldList[i];
           if (item.flag === 1) {
               let defaults = item.default ? `default ${item.default}` : '';
               let comment = item.comment ? `comment '${item.comment}'` : '';
               let nullable = item.isnull ? ' null ':' not null ';
               if (item.name === 'id') {
                   defaults = 'PRIMARY KEY';
                   if(dbtype==='sqlite'){defaults += ' AUTOINCREMENT';}else{defaults += ' AUTO_INCREMENT';}
               }else if(item.name === 'create_time') {defaults = 'DEFAULT CURRENT_TIMESTAMP';}
               if(dbtype==='sqlite'){sqllist.push(`alter table ${vapp.tableName}${s}add COLUMN  ${item.name}${s}${item.actualtype}${s}${defaults}`)}
               else{sqllist.push(`alter table ${vapp.tableName}${s}add COLUMN  ${item.name}${s}${item.actualtype}${s}${defaults}${nullable}${comment}`)}
           }
        }
    }
    console.log(sqllist);
    if(sqllist.length<1){vapp.$message.warning('无变更或不支持此变更');return}
    sqllist = base64.encode(sqllist.join(';'),1);
    $.ajax({
    type: "POST",
    url: "/echart/run_ds/",
    data: {sqlstr:sqllist, connid: connid, s:1},
    success: function(data) {
        if (data.status === 200) {
            vapp.$message.success(data.msg);
            vapp.searchfieldList();
        } else {
            vapp.$message.error(data.data);
        }
    }});
}


</script>
    <div class="modal" id="modal_iframe"><div class="modal-content modal-dash"><header class="modal-header" id="id_header">
<span class="close" onclick="hideModal()">×</span>SmartChart<a class='iconfont iconed_ds' onclick=dev_dseditor()>数据集</a><a class='iconfont iconed_chart' onclick=dev_dschart()>图形</a><a class='iconfont iconed_div' onclick=dev_dsdiv()>布局</a>
    <span class="editor_head"></span></header><div class="modal-body"><iframe id="iframepage" class="iframechart"  width="100%"></iframe></div></div></div><script src="/static/smartchart/js/dev.js?_=8.1"></script>{% endif %}
<script>var charts = [];{{echart_main|safe}}window.onresize = function(){for(let i = 0; i < charts.length; i++){charts[i].resize();}};</script>
{% block footer %}{% endblock %}<script>vapp.refreshTable();vapp.transfer_config();vapp.startRender=true;</script>
<!--powered by smartchart.cn,Designed by JohnYan mailto:84345999@qq.com, https://gitee.com/smartchart/smartchart you need keep this-->